## モデルルーティング

Gemini CLI には、モデルの障害が発生した場合にフォールバックモデルに自動的に切り替えるモデルルーティング機能が含まれています。この機能はデフォルトで有効になっており、プライマリモデルが利用できない場合に復元力（レジリエンス）を提供します。

## 仕組み

モデルルーティングはプロンプトの複雑さに基づいて行われるのではなく、フォールバックメカニズムです。仕組みは次のとおりです。

1.  **モデルの障害:** 現在選択されているモデルが応答しない場合（サーバーエラーなどの問題により）、CLI はフォールバックプロセスを開始します。

2.  **ユーザーの同意:** CLI は、フォールバックモデルに切り替えるかどうかを尋ねるプロンプトを表示します。これは `fallbackModelHandler` によって処理されます。

3.  **フォールバックのアクティブ化:** 同意すると、CLI は `config.setFallbackMode(true)` を呼び出すことでフォールバックモードをアクティブにします。

4.  **モデルの切り替え:** 次のリクエストでは、CLI は `DEFAULT_GEMINI_FLASH_MODEL` をフォールバックモデルとして使用します。これは、`packages/cli/src/zed-integration/zedIntegration.ts` の `resolveModel` 関数によって処理されます。この関数は、`isInFallbackMode()` が true であるかどうかをチェックします。

### モデル選択の優先順位

Gemini CLI が使用するモデルは、以下の優先順位で決定されます。

1.  **`--model` コマンドラインフラグ:** CLI の起動時に `--model` フラグで指定されたモデルが常に使用されます。
2.  **`GEMINI_MODEL` 環境変数:** `--model` フラグが使用されない場合、CLI は `GEMINI_MODEL` 環境変数で指定されたモデルを使用します。
3.  **`model.name` in `settings.json`:** 上記のいずれも設定されていない場合、`settings.json` ファイルの `model.name` プロパティで指定されたモデルが使用されます。
4.  **デフォルトモデル:** 上記のいずれも設定されていない場合、デフォルトモデルが使用されます。デフォルトモデルは `auto` です。