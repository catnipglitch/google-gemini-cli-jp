# Gemini CLI core

Gemini CLI の core パッケージ (`packages/core`) はバックエンド部分であり、
Gemini API との通信、ツールの管理、`packages/cli` から受け取ったリクエストの
処理を担います。全体像は
[メインのドキュメント](../index.md) を参照してください。

## セクション構成

- **[Core tools API](./tools-api.md):** ツールの定義、登録、利用方法。
- **[Memory Import Processor](./memport.md):** `@file.md` 構文を用いた GEMINI.md インポート。
- **[Policy Engine](./policy-engine.md):** ツール実行を細かく制御する仕組み。

## core の役割

`packages/cli` がユーザーインターフェースを提供する一方で、`packages/core` は次を担います。

- **Gemini API 通信:** `GEMINI_API_KEY` を使って安全に Gemini API とやり取りし、プロンプトや応答を送受信。
- **プロンプトエンジニアリング:** 会話履歴、ツール定義、`GEMINI.md` の指示文脈を取り込み、効果的なプロンプトを生成。
- **ツールの管理とオーケストレーション:**  
  - ファイル操作・シェル実行などの利用可能ツールを登録。  
  - Gemini モデルのツール利用リクエストを解釈。  
  - 引数付きでツールを実行し、結果を Gemini モデルへ返す。
- **セッション・状態管理:** 履歴や必要な文脈を追跡して一貫性ある対話を維持。
- **設定:** API キー、モデル選択、ツール設定など独自の設定を管理。

## セキュリティ考慮

- **API キー管理:** `GEMINI_API_KEY` を安全に扱い、通信時に適切に添付。
- **ツール実行:** `run_shell_command` などでローカルに手を加える際は
  サンドボックスなどの安全策を講じて、予期しない変更を防止。

## 会話履歴の圧縮

トークン制限を超えないよう、設定されたモデルに近づくと core が会話履歴を圧縮して送信します。
情報は損なわず、使用トークン数を削減します。

各モデルのトークン制限は
[Google AI ドキュメント](https://ai.google.dev/gemini-api/docs/models) で確認できます。

## モデルフォールバック

デフォルトの「pro」モデルがレート制限を受けた場合でも CLI の利用を続けられるよう、
core は自動的に現在セッションを「flash」モデルへ切り替えます。

## ファイル探索サービス

`@` コマンドなどが使う、現在のコンテキストに関連するプロジェクト内ファイルを探すサービスです。

## メモリ探索サービス

モデルに文脈を提供する `GEMINI.md` を階層的に探索・読み込みます。
現在の作業ディレクトリから順にルートやホームディレクトリ、サブディレクトリまで検索します。

これによりグローバル・プロジェクト・コンポーネント単位の文脈を組み合わせて、
最も適切な情報をモデルへ提供できます。

読み込んだ `GEMINI.md` を `show`/`add`/`refresh` したい場合は
[`/memory` コマンド](../cli/commands.md) を使用します。

## 引用

Gemini は出典元を認識すると出力末尾に引用を付けます。初期状態では有効で、
`ui.showCitations` 設定で無効化できます。

- 編集案提出時、引用は承認前に表示されます。
- 出典は常にモデルの応答末尾に表示。
- 重複を排除し、アルファベット順で表示します。
