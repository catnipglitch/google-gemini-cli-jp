# Gemini CLI コア: ツール API

Gemini CLI コア（`packages/core`）は、ツールの定義、登録、実行のための堅牢なシステムを備えています。これらのツールは Gemini モデルの機能を拡張し、ローカル環境との対話、ウェブコンテンツのフェッチ、および単純なテキスト生成以外のさまざまなアクションの実行を可能にします。

## コアコンセプト

- **ツール (`tools.ts`):** すべてのツールのコントラクトを定義するインターフェースと基底クラス（`BaseTool`）。各ツールには以下が必要です。
  - `name`: 一意の内部名（Gemini への API 呼び出しで使用）。
  - `displayName`: ユーザーフレンドリーな名前。
  - `description`: ツールの機能の明確な説明で、Gemini モデルに提供されます。
  - `parameterSchema`: ツールが受け入れるパラメータを定義する JSON スキーマ。これは、Gemini モデルがツールを正しく呼び出す方法を理解するために非常に重要です。
  - `validateToolParams()`: 入力パラメータを検証するメソッド。
  - `getDescription()`: 実行前に特定のパラメータでツールが何をするかを人間が読める形式で説明するメソッド。
  - `shouldConfirmExecute()`: 実行前にユーザー確認が必要かどうかを判断するメソッド（例: 潜在的に破壊的な操作の場合）。
  - `execute()`: ツールの動作を実行し、`ToolResult` を返すコ​​アメソッド。

- **`ToolResult` (`tools.ts`):** ツールの実行結果の構造を定義するインターフェース。
  - `llmContent`: コンテキストとして LLM に送り返される履歴に含まれる事実コンテンツ。これは単純な文字列またはリッチコンテンツ用の `PartListUnion`（`Part` オブジェクトと文字列の配列）にできます。
  - `returnDisplay`: CLI に表示するためのユーザーフレンドリーな文字列（多くの場合 Markdown）または特殊なオブジェクト（`FileDiff` など）。

- **リッチコンテンツの返却:** ツールは単純なテキストの返却に限定されません。`llmContent` は `PartListUnion` にできます。これは、`Part` オブジェクト（画像、音声など）と `string` を混在させることができる配列です。これにより、単一のツール実行で複数のリッチコンテンツを返却できます。

- **ツールレジストリ (`tool-registry.ts`):** 以下の機能を担当するクラス（`ToolRegistry`）。
  - **ツールの登録:** 利用可能なすべての組み込みツール（例: `ReadFileTool`、`ShellTool`）のコレクションを保持します。
  - **ツールの検出:** 動的にツールを検出することもできます。
    - **コマンドベースの検出:** `tools.discoveryCommand` が設定で構成されている場合、このコマンドが実行されます。カスタムツールを記述した JSON を出力し、それが `DiscoveredTool` インスタンスとして登録されることが期待されます。
    - **MCP ベースの検出:** `mcp.serverCommand` が構成されている場合、レジストリは Model Context Protocol (MCP) サーバーに接続してツールをリストし、登録できます（`DiscoveredMCPTool`）。
  - **スキーマの提供:** 登録されているすべてのツールの `FunctionDeclaration` スキーマを Gemini モデルに公開し、利用可能なツールと使用方法をモデルが認識できるようにします。
  - **ツールの取得:** コアが実行のために名前で特定のツールを取得できるようにします。

## 組み込みツール

コアには、`packages/core/src/tools/` に通常見られる一連の事前定義ツールが付属しています。これらには以下が含まれます。

- **ファイルシステムツール:**
  - `LSTool` (`ls.ts`): ディレクトリの内容をリストします。
  - `ReadFileTool` (`read-file.ts`): 単一のファイルの内容を読み取ります。
  - `WriteFileTool` (`write-file.ts`): ファイルに内容を書き込みます。
  - `GrepTool` (`grep.ts`): ファイル内のパターンを検索します。
  - `GlobTool` (`glob.ts`): glob パターンに一致するファイルを見つけます。
  - `EditTool` (`edit.ts`): ファイルのインプレース変更を実行します（多くの場合、確認が必要です）。
  - `ReadManyFilesTool` (`read-many-files.ts`): 複数のファイルまたは glob パターンから内容を読み込み、連結します（CLI の `@` コマンドで使用）。
- **実行ツール:**
  - `ShellTool` (`shell.ts`): 任意のシェルコマンドを実行します（慎重なサンドボックス化とユーザー確認が必要です）。
- **ウェブツール:**
  - `WebFetchTool` (`web-fetch.ts`): URL からコンテンツをフェッチします。
  - `WebSearchTool` (`web-search.ts`): ウェブ検索を実行します。
- **メモリツール:**
  - `MemoryTool` (`memoryTool.ts`): AI のメモリと対話します。

これらの各ツールは `BaseTool` を拡張し、特定の機能に必要なメソッドを実装しています。

## ツール実行フロー

1.  **モデル要求:** Gemini モデルは、ユーザーのプロンプトと提供されたツールスキーマに基づいて、ツールを使用することを決定し、ツールの名前と引数を指定する `FunctionCall` 部分を応答として返します。
2.  **コアが要求を受信:** コアはこの `FunctionCall` を解析します。
3.  **ツールの取得:** `ToolRegistry` で要求されたツールを検索します。
4.  **パラメータ検証:** ツールの `validateToolParams()` メソッドが呼び出されます。
5.  **確認 (必要な場合):**
    - ツールの `shouldConfirmExecute()` メソッドが呼び出されます。
    - 確認の詳細を返した場合、コアはこれを CLI に伝え、CLI はユーザーにプロンプトを表示します。
    - ユーザーの決定（例: 続行、キャンセル）はコアに送り返されます。
6.  **実行:** 検証され、確認された場合（または確認が不要な場合）、コアは提供された引数と `AbortSignal`（潜在的なキャンセル用）を使用してツールの `execute()` メソッドを呼び出します。
7.  **結果処理:** `execute()` からの `ToolResult` はコアによって受信されます。
8.  **モデルへの応答:** `llmContent` からの `ToolResult` は `FunctionResponse` としてパッケージ化され、ユーザー向けの応答を生成し続けることができるように Gemini モデルに送り返されます。
9.  **ユーザーへの表示:** `ToolResult` からの `returnDisplay` は CLI に送られ、ツールが何をしたかをユーザーに表示します。

## カスタムツールによる拡張

一般的なエンドユーザー向けの主要なワークフローとして、ユーザーによる新しいツールのプログラム的な直接登録は明示的に詳述されていませんが、アーキテクチャは以下を通じて拡張をサポートしています。

- **コマンドベースの検出:** 上級ユーザーまたはプロジェクト管理者は、`settings.json` で `tools.discoveryCommand` を定義できます。このコマンドは、Gemini CLI コアによって実行されると、`FunctionDeclaration` オブジェクトの JSON 配列を出力する必要があります。その後、コアはこれらを `DiscoveredTool` インスタンスとして利用可能にします。対応する `tools.callCommand` は、これらのカスタムツールを実際に実行する役割を担います。
- **MCP サーバー:** より複雑なシナリオでは、1つ以上の MCP サーバーを `settings.json` の `mcpServers` 設定を介してセットアップおよび構成できます。Gemini CLI コアは、これらのサーバーによって公開されるツールを検出し、使用できます。前述のとおり、複数の MCP サーバーがある場合、ツール名には構成からのサーバー名がプレフィックスとして付加されます（例: `serverAlias__actualToolName`）。

このツールシステムは、Gemini モデルの機能を強化するための柔軟で強力な方法を提供し、Gemini CLI を幅広いタスクに対応する多用途のアシスタントにしています。